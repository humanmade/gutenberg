{"version":3,"sources":["/home/circleci/project/packages/editor/src/components/block-list/index.js"],"names":["findLast","map","invert","mapValues","sortBy","throttle","Component","withSelect","withDispatch","compose","BlockListBlock","BlockListAppender","BlockList","props","onSelectionStart","bind","onSelectionEnd","setBlockRef","setLastClientY","onPointerMove","onScroll","clientY","lastClientY","nodes","window","addEventListener","removeEventListener","node","clientId","isMultiSelecting","onStartMultiSelect","boundaries","selectionAtStart","getBoundingClientRect","y","top","key","coordMapKeys","coordY","onSelectionChange","coordMap","isSelectionEnabled","clientIdToCoordMap","Object","values","onMultiSelect","selectionStart","selectionEnd","isAtStart","cancel","onStopMultiSelect","blockClientIds","rootClientId","isDraggable","blockIndex","length","select","ownProps","getBlockOrder","getMultiSelectedBlocksStartClientId","getMultiSelectedBlocksEndClientId","dispatch","startMultiSelect","stopMultiSelect","multiSelect"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport {\n\tfindLast,\n\tmap,\n\tinvert,\n\tmapValues,\n\tsortBy,\n\tthrottle,\n} from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport { withSelect, withDispatch } from '@wordpress/data';\nimport { compose } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport BlockListBlock from './block';\nimport BlockListAppender from '../block-list-appender';\n\nclass BlockList extends Component {\n\tconstructor( props ) {\n\t\tsuper( props );\n\n\t\tthis.onSelectionStart = this.onSelectionStart.bind( this );\n\t\tthis.onSelectionEnd = this.onSelectionEnd.bind( this );\n\t\tthis.setBlockRef = this.setBlockRef.bind( this );\n\t\tthis.setLastClientY = this.setLastClientY.bind( this );\n\t\tthis.onPointerMove = throttle( this.onPointerMove.bind( this ), 100 );\n\t\t// Browser does not fire `*move` event when the pointer position changes\n\t\t// relative to the document, so fire it with the last known position.\n\t\tthis.onScroll = () => this.onPointerMove( { clientY: this.lastClientY } );\n\n\t\tthis.lastClientY = 0;\n\t\tthis.nodes = {};\n\t}\n\n\tcomponentDidMount() {\n\t\twindow.addEventListener( 'mousemove', this.setLastClientY );\n\t}\n\n\tcomponentWillUnmount() {\n\t\twindow.removeEventListener( 'mousemove', this.setLastClientY );\n\t}\n\n\tsetLastClientY( { clientY } ) {\n\t\tthis.lastClientY = clientY;\n\t}\n\n\tsetBlockRef( node, clientId ) {\n\t\tif ( node === null ) {\n\t\t\tdelete this.nodes[ clientId ];\n\t\t} else {\n\t\t\tthis.nodes = {\n\t\t\t\t...this.nodes,\n\t\t\t\t[ clientId ]: node,\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Handles a pointer move event to update the extent of the current cursor\n\t * multi-selection.\n\t *\n\t * @param {MouseEvent} event A mousemove event object.\n\t *\n\t * @return {void}\n\t */\n\tonPointerMove( { clientY } ) {\n\t\t// We don't start multi-selection until the mouse starts moving, so as\n\t\t// to avoid dispatching multi-selection actions on an in-place click.\n\t\tif ( ! this.props.isMultiSelecting ) {\n\t\t\tthis.props.onStartMultiSelect();\n\t\t}\n\n\t\tconst boundaries = this.nodes[ this.selectionAtStart ].getBoundingClientRect();\n\t\tconst y = clientY - boundaries.top;\n\t\tconst key = findLast( this.coordMapKeys, ( coordY ) => coordY < y );\n\n\t\tthis.onSelectionChange( this.coordMap[ key ] );\n\t}\n\n\t/**\n\t * Binds event handlers to the document for tracking a pending multi-select\n\t * in response to a mousedown event occurring in a rendered block.\n\t *\n\t * @param {string} clientId Client ID of block where mousedown occurred.\n\t *\n\t * @return {void}\n\t */\n\tonSelectionStart( clientId ) {\n\t\tif ( ! this.props.isSelectionEnabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst boundaries = this.nodes[ clientId ].getBoundingClientRect();\n\n\t\t// Create a clientId to Y coördinate map.\n\t\tconst clientIdToCoordMap = mapValues( this.nodes, ( node ) =>\n\t\t\tnode.getBoundingClientRect().top - boundaries.top );\n\n\t\t// Cache a Y coördinate to clientId map for use in `onPointerMove`.\n\t\tthis.coordMap = invert( clientIdToCoordMap );\n\t\t// Cache an array of the Y coördinates for use in `onPointerMove`.\n\t\t// Sort the coördinates, as `this.nodes` will not necessarily reflect\n\t\t// the current block sequence.\n\t\tthis.coordMapKeys = sortBy( Object.values( clientIdToCoordMap ) );\n\t\tthis.selectionAtStart = clientId;\n\n\t\twindow.addEventListener( 'mousemove', this.onPointerMove );\n\t\t// Capture scroll on all elements.\n\t\twindow.addEventListener( 'scroll', this.onScroll, true );\n\t\twindow.addEventListener( 'mouseup', this.onSelectionEnd );\n\t}\n\n\t/**\n\t * Handles multi-selection changes in response to pointer move.\n\t *\n\t * @param {string} clientId Client ID of block under cursor in multi-select\n\t *                          drag.\n\t */\n\tonSelectionChange( clientId ) {\n\t\tconst { onMultiSelect, selectionStart, selectionEnd } = this.props;\n\t\tconst { selectionAtStart } = this;\n\t\tconst isAtStart = selectionAtStart === clientId;\n\n\t\tif ( ! selectionAtStart || ! this.props.isSelectionEnabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If multi-selecting and cursor extent returns to the start of\n\t\t// selection, cancel multi-select.\n\t\tif ( isAtStart && selectionStart ) {\n\t\t\tonMultiSelect( null, null );\n\t\t}\n\n\t\t// Expand multi-selection to block under cursor.\n\t\tif ( ! isAtStart && selectionEnd !== clientId ) {\n\t\t\tonMultiSelect( selectionAtStart, clientId );\n\t\t}\n\t}\n\n\t/**\n\t * Handles a mouseup event to end the current cursor multi-selection.\n\t *\n\t * @return {void}\n\t */\n\tonSelectionEnd() {\n\t\t// Cancel throttled calls.\n\t\tthis.onPointerMove.cancel();\n\n\t\tdelete this.coordMap;\n\t\tdelete this.coordMapKeys;\n\t\tdelete this.selectionAtStart;\n\n\t\twindow.removeEventListener( 'mousemove', this.onPointerMove );\n\t\twindow.removeEventListener( 'scroll', this.onScroll, true );\n\t\twindow.removeEventListener( 'mouseup', this.onSelectionEnd );\n\n\t\t// We may or may not be in a multi-selection when mouseup occurs (e.g.\n\t\t// an in-place mouse click), so only trigger stop if multi-selecting.\n\t\tif ( this.props.isMultiSelecting ) {\n\t\t\tthis.props.onStopMultiSelect();\n\t\t}\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\tblockClientIds,\n\t\t\trootClientId,\n\t\t\tisDraggable,\n\t\t} = this.props;\n\n\t\treturn (\n\t\t\t<div className=\"editor-block-list__layout\">\n\t\t\t\t{ map( blockClientIds, ( clientId, blockIndex ) => (\n\t\t\t\t\t<BlockListBlock\n\t\t\t\t\t\tkey={ 'block-' + clientId }\n\t\t\t\t\t\tindex={ blockIndex }\n\t\t\t\t\t\tclientId={ clientId }\n\t\t\t\t\t\tblockRef={ this.setBlockRef }\n\t\t\t\t\t\tonSelectionStart={ this.onSelectionStart }\n\t\t\t\t\t\trootClientId={ rootClientId }\n\t\t\t\t\t\tisFirst={ blockIndex === 0 }\n\t\t\t\t\t\tisLast={ blockIndex === blockClientIds.length - 1 }\n\t\t\t\t\t\tisDraggable={ isDraggable }\n\t\t\t\t\t/>\n\t\t\t\t) ) }\n\t\t\t\t<BlockListAppender rootClientId={ rootClientId } />\n\t\t\t</div>\n\t\t);\n\t}\n}\n\nexport default compose( [\n\twithSelect( ( select, ownProps ) => {\n\t\tconst {\n\t\t\tgetBlockOrder,\n\t\t\tisSelectionEnabled,\n\t\t\tisMultiSelecting,\n\t\t\tgetMultiSelectedBlocksStartClientId,\n\t\t\tgetMultiSelectedBlocksEndClientId,\n\t\t} = select( 'core/editor' );\n\t\tconst { rootClientId } = ownProps;\n\n\t\treturn {\n\t\t\tblockClientIds: getBlockOrder( rootClientId ),\n\t\t\tselectionStart: getMultiSelectedBlocksStartClientId(),\n\t\t\tselectionEnd: getMultiSelectedBlocksEndClientId(),\n\t\t\tisSelectionEnabled: isSelectionEnabled(),\n\t\t\tisMultiSelecting: isMultiSelecting(),\n\t\t};\n\t} ),\n\twithDispatch( ( dispatch ) => {\n\t\tconst {\n\t\t\tstartMultiSelect,\n\t\t\tstopMultiSelect,\n\t\t\tmultiSelect,\n\t\t} = dispatch( 'core/editor' );\n\n\t\treturn {\n\t\t\tonStartMultiSelect: startMultiSelect,\n\t\t\tonStopMultiSelect: stopMultiSelect,\n\t\t\tonMultiSelect: multiSelect,\n\t\t};\n\t} ),\n] )( BlockList );\n"]}